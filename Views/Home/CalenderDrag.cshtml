@{
    var lines = ViewBag.Lines as List<WebApplication1.Models.SewingLine>;
    var linesJson = Newtonsoft.Json.JsonConvert.SerializeObject(lines);
    var tasks = ViewBag.Tasks as List<WebApplication1.Models.TaskIteMForDragAndDROP>;
    var tasksJson = Newtonsoft.Json.JsonConvert.SerializeObject(tasks);
    // Use dates from ViewBag (passed from controller)
    DateTime startDate = ViewBag.StartDate;
    DateTime endDate = ViewBag.EndDate;

    int workingHours = 10;

    // For navigation, previous and next month based on startDate
    DateTime currentMonth = new DateTime(startDate.Year, startDate.Month, 1);
    DateTime prevMonth = currentMonth.AddMonths(-12);
    DateTime nextMonth = currentMonth.AddMonths(11);
}

<style>
    /* --- Styles (same as before) --- */
    body {
        font-family: Arial;
    }

    .calendar {
        border: 1px solid #ccc;
        overflow-x: auto;
        overflow-y: auto;
        position: relative;
        background: #fff;
        width: 100%;
        white-space: nowrap;
        max-height: 700px;
    }

    .row {
        display: flex;
        position: relative;
        border-bottom: 1px solid #eee;
        height: 50px;
        flex-wrap: nowrap;
    }

    .line-name {
        width: 120px;
        background: #f3f3f3;
        border-right: 1px solid #ccc;
        font-weight: bold;
        flex: 0 0 120px;
        position: sticky;
        left: 0;
        z-index: 90;
    }

    .row:first-child .line-name {
        z-index: 110;
    }

    .cell {
        min-width: 40px;
        max-width: 40px;
        flex: 0 0 40px;
        border-right: 1px solid #F5E5E1;
        border-bottom: 1px solid #F5E5E1;
        text-align: center;
        font-size: 12px;
        box-sizing: border-box;
        position: relative;
    }

    .hour-row {
        display: flex;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    .hour-mini {
        flex: 1;
        border-left: 1px solid white;
        height: 100%;
    }

    /* .task {
            position: absolute;
            top: 5px;
            height: 40px;
            border-radius: 4px;
            color: #fff;
            font-size: 12px;
            padding: 5px;
            cursor: move;
            user-select: none;
            z-index: 50;
        }
    */


    .task {
        background-color: #F9DFDF;
        width: 40%;
        position: absolute;
        top: 50%;
        font-weight: 100;
        height: 45px;
        justify-content: center;
        border: 1px solid #333;
        /*    transform: translateY(-50%);*/
    }

    .today {
        background: #ffe082 !important;
        font-weight: bold;
    }

    .today-line {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: red;
        z-index: 5;
        pointer-events: none;
    }

    .row:first-child {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
    }

    .line-title {
        font-weight: 600;
        font-size: 14px;
    }

    .line-info {
        margin-top: 4px;
        font-size: 12px;
        color: #666;
        display: flex;
        gap: 10px;
    }

    /* .task.drag-preview {
            opacity: 0.7;
            outline: 2px dashed #333;
        }*/


</style>



<h3>Sewing Line Calendar</h3>

<!-- Date Selection Form -->
<div style="margin-bottom: 15px;">
    <form id="dateForm" method="get" action="@Url.Action("CalenderDrag")">
        <label>
            From:
            <input type="date" name="FromDate" value="@startDate.ToString("yyyy-MM-dd")" />
        </label>
        <label style="margin-left: 10px;">
            To:
            <input type="date" name="ToDate" value="@endDate.ToString("yyyy-MM-dd")" />
        </label>
        <button type="submit" style="margin-left: 10px;">Load Calendar</button>
        <button type="button" id="btn-tasks" style="margin-left: 10px;">Load Tasks</button>

    </form>


    <div class="container-fluid">
        <div class="row">


            <div class="col-3 bg-dark text-white p-3" style="height: 100vh; overflow-y:auto;">

                <h4 class="mb-3">Order List</h4>

                <!-- Orders will be loaded here -->
                <ul class="list-group" id="sidebar-orders">
                    <li class="text-white">Loading...</li>
                </ul>

            </div>




            <div class="col-9">

                <div class="calendar" id="calendar">

                    <!-- Header Row -->
                    <div class="row">
                        <div class="line-name">Line</div>
                        @for (var d = startDate; d <= endDate; d = d.AddDays(1))
                        {
                            var isToday = d.Date == DateTime.Today;
                            <div class="cell @(isToday ? "today" : "")">@d.ToString("dd")</div>
                        }
                    </div>

                    <!-- Lines & Tasks -->
                    @foreach (var line in lines)
                    {
                        <div class="row" data-line="@line.LINE_ID" data-ManPower="@line.MAN_POWER" data-ManWorkLimite="@line.ManWorkLimite">
                            <div class="line-name">
                                <div class="line-title">@line.LINE_NAME</div>
                                <div class="line-info">
                                    <span>MP: @line.MAN_POWER</span>
                                    <span>Limit/H: @line.ManWorkLimite</span>
                                </div>
                            </div>

                            @for (var d = startDate; d <= endDate; d = d.AddDays(1))
                            {
                                var isToday = d.Date == DateTime.Today;
                                <div class="cell @(isToday ? "today" : "")" data-date="@d.ToString("yyyy-MM-dd")">
                                    <div class="hour-row">
                                        @for (int h = 0; h < workingHours; h++)
                                        {
                                            <div class="hour-mini" data-hour="@h"></div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>

            </div>

        </div>
    </div>




    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script>

        var tasks = @Html.Raw(tasksJson);
        var lines = @Html.Raw(linesJson);
      const workingHours = @workingHours;
    $(document).ready(function () {
        loadSwingLine();
        LoadOrders();

        // Order drag and drop
        let draggedOrder = null; // use let, not const

        // DRAG START for orders
        $(document).on('dragstart', '.draggable-order', function (e) {
            draggedOrder = $(this);
        });

        // DRAG END
        $(document).on('dragend', '.draggable-order', function () {
            draggedOrder = null;
        });

        // Drag over cells
        $(document).on('dragover', '.cell', function (e) {
            e.preventDefault();
            $(this).addClass('cell-hover');
        });

        $(document).on('dragleave', '.cell', function () {
            $(this).removeClass('cell-hover');
        });

        // DROP: create task from order
        $(document).on('drop', '.cell', function (e) {
            e.preventDefault();
            $(this).removeClass('cell-hover');

            if (!draggedOrder) return;

            const $cell = $(this);
            const $row = $cell.closest('.row');
            const lineId = $row.data('line');
            const startDate = $cell.data('date');

            const $hourMini = $(e.target).closest('.hour-mini');
            let startHour = 0; // default
            if ($hourMini.length) {
                startHour = parseInt($hourMini.data('hour'));
            }

            
            const order = {
                OrderId: parseInt(draggedOrder.find('strong').text().replace('Order #', '')),
                Quantity: parseInt(draggedOrder.data('quantity')) || 10
            };

          
            const line = lines.find(l => l.LINE_ID == lineId);
            if (!line) {
                console.error("Line not found for ID:", lineId);
                return;
            }

           
            
            const durationDays = 10;

          
            const newTask = createTaskFromOrder(order, line, startDate, durationDays, startHour);

          

            
            draggedOrder = null;

           
            const fromDate = $('input[name="FromDate"]').val();
            LoadTask(tasks, fromDate);
        });





        //task drag and drop
        let draggedTask = null;


    document.addEventListener("dragstart", e => {
        //if (!e.target.classList.contains("task")) return;

        //draggedTask = e.target;

        //e.dataTransfer.setData("text/plain", "");
        if (e.target.classList.contains("task")) {
            draggedTask = e.target;
            e.dataTransfer.setData("text/plain", e.target.dataset.id);
            //e.dataTransfer.effectAllowed = "move";
        }

    });

    document.addEventListener("dragend", e => {
        if (!draggedTask) return;
        draggedTask = null;
    });

    document.addEventListener("dragover", e => {
        e.preventDefault();

        if (!draggedTask) return;

        const cell = e.target.closest(".cell");
        const hourMini = e.target.closest(".hour-mini");
        const row = e.target.closest(".row");

        if (!cell || !hourMini || !row) return;

        const lineId = row.dataset.line;
        const startDateStr = cell.dataset.date;      // yyyy-mm-dd
        const startHour = parseInt(hourMini.dataset.hour);
        const GivenDurationHours = 10;
        const TaskId = draggedTask.dataset.id;
        const TaskQuantity = draggedTask.dataset.quantity;
        const LineWorkingHourCapacity = row.dataset.manworklimite;
        const LineManPower = row.dataset.manpower;

        const estimated = calculateEstimatedEndDate(startDateStr, startHour, GivenDurationHours, LineWorkingHourCapacity, LineManPower, TaskQuantity)

        var taskDrag = updatedTak(TaskId, startDateStr, estimated.endDate, startHour, estimated.endHour, lineId)

        const fromDate = $('input[name="FromDate"]').val();
        LoadTask(tasks, fromDate);
       
    });


    document.addEventListener("drop", e => {
        e.preventDefault();
        if (!draggedTask) return;

        const hourMini = e.target.closest(".hour-mini");
        const cell = e.target.closest(".cell");
        const row = e.target.closest(".row");

        if (!hourMini || !cell || !row) {
            draggedTask = null;
            return;
        }

    
        row.appendChild(draggedTask);

        // Start hour & day index
        const startHour = parseInt(hourMini.dataset.hour, 10);
        const allCells = Array.from(row.querySelectorAll(".cell"));
        const dayIndex = allCells.indexOf(cell);

        // Position calculations
        const lineWidth = row.querySelector(".line-name").offsetWidth;
        const dayWidth = row.querySelector(".cell").offsetWidth;
        const hourWidth = dayWidth / workingHours;

        draggedTask.style.position = "absolute";
        draggedTask.style.left = (lineWidth + dayIndex * dayWidth + startHour * hourWidth) + "px";
        draggedTask.style.top = "5px";

        // Full task width based on duration
        const durationDays = parseInt(draggedTask.dataset.duration || "1", 10);
        draggedTask.style.width = (durationDays * dayWidth) + "px";

        // Log info
      

        draggedTask = null;
        const fromDate = $('input[name="FromDate"]').val();
        LoadTask(tasks, fromDate);
    });




        function updatedTak(taskId, fromDate, toDate,startHour,endHour,lineID) {

            console.clear();
        console.log("tasks", tasks);
        console.log("ID", taskId);
        console.log("StartDate", fromDate);
        console.log("EndDate", toDate);
        console.log("lineID", lineID);
        console.log("endHour", endHour);
        console.log("startHour", startHour);
        const task = tasks.find(t => t.Id == taskId);
        if (!task) {
            console.warn("Task not found:", taskId);
            return;
        }

        task.FromDate = fromDate;
        task.ToDate = toDate;
        task.SewingLineId = lineID;
        task.endHour = endHour;
       task.startHour = startHour

        return task;
        }



    });

       
        function LoadOrders() {
            $.ajax({
                url: '/Home/Orders',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    let sidebarList = $('#sidebar-orders');
                    sidebarList.empty();

                    if (!data || data.length === 0) {
                        sidebarList.append('<li class="text-white">No orders found.</li>');
                        return;
                    }

                    data.forEach(order => {
                        // Make li draggable
                        let li = $(`
                    <li class="list-group-item bg-dark text-white border-secondary draggable-order"
                        draggable="true"
                        data-orderid="${order.OrderId}"
                        data-quantity="${order.Quantity}">
                        <strong>Order #${order.OrderId}</strong><br>
                        Company: ${order.OrderCompany || ''}<br>
                        Qty: ${order.Quantity} pcs
                    </li>
                `);

                      

                        sidebarList.append(li);
                    });
                },
                error: function () {
                    $('#sidebar-orders').html('<li class="text-white">Error loading orders.</li>');
                }
            });
        }





    function dayDiff(date1, date2) {
        const d1 = new Date(date1);
        const d2 = new Date(date2);

        if (isNaN(d1) || isNaN(d2)) {
            console.error("Invalid dates in dayDiff", date1,'~~~~~~~~~', date2);
            return NaN;
        }

        d1.setHours(0, 0, 0, 0);
        d2.setHours(0, 0, 0, 0);

        return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
    }

    //function LoadTask(tasks, calendarStartDate) {

    //    $('.task').remove();

    //    const calendarStart = new Date(calendarStartDate);
    //    calendarStart.setHours(0, 0, 0, 0);

    //    tasks.forEach(task => {

    //        const $row = $('.row[data-line="' + task.SewingLineId + '"]');
    //        if (!$row.length) return;

    //        const $firstCell = $row.find('.cell').first();
    //        if (!$firstCell.length) return;

    //        const taskStart = new Date(task.FromDate.split('T')[0]);
    //        const taskEnd = new Date(task.ToDate.split('T')[0]);

    //        const taskStartHour = task.startHour;
    //        const taskEndHour = task.endHour;

    //        const startDay = dayDiff(calendarStart, taskStart);
    //        const duration = dayDiff(taskStart, taskEnd) + 1;

    //        if (startDay < 0 || duration <= 0) return;

    //        const dayWidth = $firstCell.outerWidth();
    //        const leftBase = $row.find('.line-name').outerWidth();

    //        const $task = $('<div>', {
    //            class: 'task',
    //            text: task.TaskName,
    //            draggable: true,
    //            css: {
    //                left: leftBase + startDay * dayWidth + 'px',
    //                top: '6px',
    //                width: duration * dayWidth + 'px',
    //                position: 'absolute',
    //                //background: task.ColorCode || '#87cefa',
    //                border: '1px solid #333',
    //                //height: '22px',
    //                lineHeight: '22px',
    //                overflow: 'hidden',
    //                whiteSpace: 'nowrap'
    //            }
    //        })
    //            .attr('data-id', task.Id)
    //            .attr('data-duration', duration)
    //            .attr('data-quantity', task.Quantity);

    //        $row.append($task);
    //    });
    //}

   function LoadTask(tasks, calendarStartDate) {
    const workingHours = @workingHours;
    $('.task').remove();

    const calendarStart = new Date(calendarStartDate);
    calendarStart.setHours(0, 0, 0, 0);

    tasks.forEach(task => {

        const $row = $('.row[data-line="' + task.SewingLineId + '"]');
        if (!$row.length) return;

        const $firstCell = $row.find('.cell').first();
        if (!$firstCell.length) return;

        // ✔ Get REAL hour width
        const cellWidth = $firstCell.find('.hour-mini').first().outerWidth();

        // ✔ Calculate full day width
        const dayWidth = workingHours * cellWidth;

        // ✔ Left base (line name width)
        const leftBase = $row.find('.line-name').outerWidth();

        // Task dates
        const taskStartDate = new Date(task.FromDate.split('T')[0]);
        const taskEndDate = new Date(task.ToDate.split('T')[0]);

        const startDay = dayDiff(calendarStart, taskStartDate);
        if (startDay < 0) return;

        let totalWidth = 0;

       
        if (taskStartDate.toDateString() === taskEndDate.toDateString()) {
            totalWidth = (task.EndHour - task.StartHour + 1) * cellWidth;
        }
        else {
           
            const firstDayWidth  = (workingHours - task.StartHour) * cellWidth;
            const lastDayWidth   = (task.EndHour + 1) * cellWidth;
            const middleDays     = dayDiff(taskStartDate, taskEndDate) - 1;

            totalWidth = firstDayWidth +
                (middleDays > 0 ? middleDays * dayWidth : 0) +
                lastDayWidth;
        }

      
        const leftOffset =
            leftBase +
            (startDay * dayWidth) +
            (task.StartHour * cellWidth);


        const $task = $('<div>', {
            class: 'task',
            text: task.TaskName,
            draggable: true,
            css: {
                left: leftOffset + 'px',
                top: '6px',
                width: totalWidth + 'px',
                position: 'absolute',
                border: '1px solid #333',
                lineHeight: '20px',
                overflow: 'hidden',
                whiteSpace: 'nowrap'
            }
        })
        .attr('data-id', task.Id)
        .attr('data-duration', dayDiff(taskStartDate, taskEndDate) + 1)
        .attr('data-quantity', task.Quantity);

        $row.append($task);
    });
}


        function createTaskFromOrder(order, line, startDate, givenDurationHours, startHour) {
         
            givenDurationHours = givenDurationHours || 10;

            // Validate input
            if (!order || !line || !startDate) {
                console.error("Missing required parameters to create task");
                return null;
            }

            
            const estimated = calculateEstimatedEndDate(
                startDate,              
                startHour,               
                givenDurationHours,      
                line.ManWorkLimite,     
                line.MAN_POWER,        
                order.Quantity      
            );

            if (!estimated || !estimated.endDate || estimated.endHour === undefined) {
                console.error("Estimated calculation failed:", estimated);
                return null;
            }
            

            // Create the task object
            const task = {
                Id: tasks.length + 1,                            
                TaskName: `Task From Order #${order.OrderId}`, 
                Quantity: order.Quantity,
                SewingLineId: line.LINE_ID,
                SewingLine: null,                               
                FromDate: new Date(startDate).toISOString(),    
                ToDate: new Date(estimated.endDate).toISOString(), 
                StartHour: startHour,
                EndHour: estimated.endHour,
                ColorCode: 'blue'                            
            };

            console.log("newTask:", task);  

            tasks.push(task); 
            return task;     
        }




        function calculateEstimatedEndDate(startDateStr, startHour, givenDurationDays, lineWorkingHourCapacity, lineManPower, taskQuantity) {
            const totalRequiredHours = Math.ceil(taskQuantity / lineWorkingHourCapacity);
            const maxAllowedHours = givenDurationDays * workingHours;
            let hoursToSchedule = totalRequiredHours;
            let currentDate = new Date(startDateStr);
            let currentHour = startHour;

            while (hoursToSchedule > 0) {
                const availableHoursToday = workingHours - currentHour;
            
                if (hoursToSchedule <= availableHoursToday) {
                    currentHour += hoursToSchedule;
                    hoursToSchedule = 0;
                } else {
                    hoursToSchedule -= availableHoursToday;
                    currentDate.setDate(currentDate.getDate() + 1);
                    currentHour = 0;
                }
            }


            //console.log("startHour", startHour);
            // Make endHour 1 to lineWorkingHourCapacity
            if (currentHour === 0) currentHour = lineWorkingHourCapacity;

            return {
                endDate: currentDate.toISOString().split("T")[0],
                endHour: currentHour
            };
        }

 $('#btn-tasks').on('click', function (event) {
     event.preventDefault();

     const fromDate = $('input[name="FromDate"]').val();
     const toDate = $('input[name="ToDate"]').val();

     console.log("Load tasks for:", fromDate, "to", toDate);

     LoadTask(tasks, fromDate);
 });


    function loadSwingLine() {
        $.ajax({
            url: '/Home/SwingLineForPlan',
            type: 'GET',
            dataType: 'json',
            success: function (response) {
                console.log('Swing Line Data:', response);
                response.forEach(function (line) {

                });
            },
            error: function (err) {
                console.error('Error loading swing line', err);
            }
        });
    }


window.addEventListener("load", () => {
    document.querySelectorAll(".row").forEach(row => {
        const leftCol = row.querySelector(".line-name");
        if (!leftCol) return;

        const leftOffset = leftCol.getBoundingClientRect().width;
        const firstCell = row.querySelector(".cell");
        const dayWidth = firstCell.getBoundingClientRect().width;

        row.querySelectorAll(".task").forEach(task => {
            const startDay = parseInt(task.dataset.startDay || "0");
            const duration = parseInt(task.dataset.duration || "1");

            task.style.left = (startDay * dayWidth + leftOffset) + "px";
            task.style.width = (duration * dayWidth) + "px";
            task.style.top = "5px";
        });
    });

    const calendar = document.getElementById("calendar");
    const todayCell = document.querySelector(".cell.today");
    if (calendar && todayCell) {
        calendar.scrollLeft = todayCell.offsetLeft - (calendar.clientWidth / 2);

        const todayLine = document.createElement("div");
        todayLine.className = "today-line";
        todayLine.style.left = todayCell.offsetLeft + "px";
        calendar.appendChild(todayLine);
    }




});

    </script>

