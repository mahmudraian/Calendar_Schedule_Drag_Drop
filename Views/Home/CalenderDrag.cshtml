@{
    var lines = ViewBag.Lines as List<WebApplication1.Models.SewingLine>;
    var tasks = ViewBag.Tasks as List<WebApplication1.Models.TaskIteMForDragAndDROP>;
    var tasksJson = Newtonsoft.Json.JsonConvert.SerializeObject(tasks);
    // Use dates from ViewBag (passed from controller)
    DateTime startDate = ViewBag.StartDate;
    DateTime endDate = ViewBag.EndDate;

    int workingHours = 10;

    // For navigation, previous and next month based on startDate
    DateTime currentMonth = new DateTime(startDate.Year, startDate.Month, 1);
    DateTime prevMonth = currentMonth.AddMonths(-1);
    DateTime nextMonth = currentMonth.AddMonths(1);
}

<style>
    /* --- Styles (same as before) --- */
    body {
        font-family: Arial;
    }

    .calendar {
        border: 1px solid #ccc;
        overflow-x: auto;
        overflow-y: auto;
        position: relative;
        background: #fff;
        width: 100%;
        white-space: nowrap;
    }

    .row {
        display: flex;
        position: relative;
        border-bottom: 1px solid #eee;
        height: 50px;
        flex-wrap: nowrap;
    }

    .line-name {
        width: 120px;
        background: #f3f3f3;
        border-right: 1px solid #ccc;
        font-weight: bold;
        flex: 0 0 120px;
        position: sticky;
        left: 0;
        z-index: 90;
    }

    .row:first-child .line-name {
        z-index: 110;
    }

    .cell {
        min-width: 40px;
        max-width: 40px;
        flex: 0 0 40px;
        border-right: 1px solid #F5E5E1;
        border-bottom: 1px solid #F5E5E1;
        text-align: center;
        font-size: 12px;
        box-sizing: border-box;
        position: relative;
    }

    .hour-row {
        display: flex;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    .hour-mini {
        flex: 1;
        border-left: 1px solid white;
        height: 100%;
    }

   /* .task {
        position: absolute;
        top: 5px;
        height: 40px;
        border-radius: 4px;
        color: #fff;
        font-size: 12px;
        padding: 5px;
        cursor: move;
        user-select: none;
        z-index: 50;
    }
*/


    .task {
        background-color: #F9DFDF;
        width: 40%;
        position: absolute;
        top: 50%;
        font-weight:100;
        height:45px;
       justify-content:center;
        /*    transform: translateY(-50%);*/
    }

    .today {
        background: #ffe082 !important;
        font-weight: bold;
    }

    .today-line {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: red;
        z-index: 5;
        pointer-events: none;
    }

    .row:first-child {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
    }

    .line-title {
        font-weight: 600;
        font-size: 14px;
    }

    .line-info {
        margin-top: 4px;
        font-size: 12px;
        color: #666;
        display: flex;
        gap: 10px;
    }
</style>

<h3>Sewing Line Calendar</h3>

<!-- Date Selection Form -->
<div style="margin-bottom: 15px;">
    <form id="dateForm" method="get" action="@Url.Action("CalenderDrag")">
        <label>
            From:
            <input type="date" name="FromDate" value="@startDate.ToString("yyyy-MM-dd")" />
        </label>
        <label style="margin-left: 10px;">
            To:
            <input type="date" name="ToDate" value="@endDate.ToString("yyyy-MM-dd")" />
        </label>
        <button type="submit" style="margin-left: 10px;">Load Calendar</button>
    </form>
</div>


<div class="calendar" id="calendar">

    <!-- Header Row -->
    <div class="row">
        <div class="line-name">Line</div>
        @for (var d = startDate; d <= endDate; d = d.AddDays(1))
        {
            var isToday = d.Date == DateTime.Today;
            <div class="cell @(isToday ? "today" : "")">@d.ToString("dd")</div>
        }
    </div>

   
    @foreach (var line in lines)
    {
        <div class="row" data-line="@line.Id" data-ManPower="@line.ManPower" data-ManWorkLimite="@line.ManWorkLimite">
            <div class="line-name">

                <div class="line-title">@line.LineName</div>
                <div class="line-info">
                    <span>MP: @line.ManPower</span>
                    <span>Limit/H: @line.ManWorkLimite</span>
                </div>

            </div>


            @for (var d = startDate; d <= endDate; d = d.AddDays(1))
            {
                var isToday = d.Date == DateTime.Today;
                <div class="cell @(isToday ? "today" : "")" data-date="@d.ToString("yyyy-MM-dd")">
                    <div class="hour-row">
                        @for (int h = 0; h < workingHours; h++)
                        {
                            <div class="hour-mini" data-hour="@h"></div>
                        }
                    </div>
                </div>
            }

            @{
                var lineTasks = tasks.Where(t => t.SewingLineId == line.Id).ToList();
            }

            @foreach (var task in lineTasks)
            {
                var startOffset = (task.FromDate - startDate).Days;
                var dayCount = (task.ToDate - task.FromDate).Days + 1;

                <div class="task"
                     draggable="true"
                     data-id="@task.Id"
                     data-start-day="@startOffset"
                     data-duration="@dayCount"
                     data-quantity="@task.Quantity"
                     @*style="background:@task.ColorCode;"*@
                     >
                    @task.TaskName
                </div>
            }
        </div> 
    }
</div>

<script>
(() => {
    const workingHours = @workingHours;
    let dragged = null;

      var tasks = @Html.Raw(tasksJson);
    
    document.addEventListener("dragstart", e => {
        //if (!e.target.classList.contains("task")) return;

        //draggedTask = e.target;

        //e.dataTransfer.setData("text/plain", "");
        if (e.target.classList.contains("task")) {
            draggedTask = e.target;
            e.dataTransfer.setData("text/plain", e.target.dataset.id);
            e.dataTransfer.effectAllowed = "move";
        }

    });

    document.addEventListener("dragend", e => {
        if (!draggedTask) return;
        draggedTask = null;
    });

    document.addEventListener("dragover", e => {
        e.preventDefault();

        if (!draggedTask) return;

        const cell = e.target.closest(".cell");
        const hourMini = e.target.closest(".hour-mini");
        const row = e.target.closest(".row");

        if (!cell || !hourMini || !row) return;

        const lineId = row.dataset.line;
        const startDateStr = cell.dataset.date;      // yyyy-mm-dd
        const startHour = parseInt(hourMini.dataset.hour);
        const GivenDurationHours = 10;
        const TaskId = draggedTask.dataset.id;
        const TaskQuantity = draggedTask.dataset.quantity;
        const LineWorkingHourCapacity = row.dataset.manworklimite;
        const LineManPower = row.dataset.manpower;

        const estimated = calculateEstimatedEndDate(startDateStr, startHour, GivenDurationHours, LineWorkingHourCapacity, LineManPower, TaskQuantity)
        console.log("tasks", tasks);
        updatedTak(TaskId, startDateStr, estimated.endDate)

        

        //console.log("Line ID:", lineId);
        console.log("Start:", startDateStr, startHour + ":00");
        console.log("Estimated END:", estimated.endDate, estimated.endHour + ":00");
        //console.log("Task Quantity:", TaskQuantity);
        //console.log("Working Hour Capacity:", LineWorkingHourCapacity);
        //console.log("Man Powerv:", LineManPower);
        console.log("estimated:", estimated);
    });


    document.addEventListener("drop", e => {
        e.preventDefault();
        if (!draggedTask) return;

        const hourMini = e.target.closest(".hour-mini");
        const cell = e.target.closest(".cell");
        const row = e.target.closest(".row");

        if (!hourMini || !cell || !row) {
            draggedTask = null;
            return;
        }


        row.appendChild(draggedTask);

        // Start hour & day index
        const startHour = parseInt(hourMini.dataset.hour, 10);
        const allCells = Array.from(row.querySelectorAll(".cell"));
        const dayIndex = allCells.indexOf(cell);

        // Position calculations
        const lineWidth = row.querySelector(".line-name").offsetWidth;
        const dayWidth = row.querySelector(".cell").offsetWidth;
        const hourWidth = dayWidth / workingHours;

        draggedTask.style.position = "absolute";
        draggedTask.style.left = (lineWidth + dayIndex * dayWidth + startHour * hourWidth) + "px";
        draggedTask.style.top = "5px";

        // Full task width based on duration
        const durationDays = parseInt(draggedTask.dataset.duration || "1", 10);
        draggedTask.style.width = (durationDays * dayWidth) + "px";

        // Log info
        console.log({
            taskId: draggedTask.dataset.id,
            lineId: row.dataset.line,
            startDate: cell.dataset.date,
            startHour,
            durationDays
        });

        draggedTask = null;
    });

    function calculateEstimatedEndDate(startDateStr, startHour, givenDurationDays, lineWorkingHourCapacity, lineManPower, taskQuantity) {
        const totalRequiredHours = Math.ceil(taskQuantity / lineWorkingHourCapacity);
        const maxAllowedHours = givenDurationDays * workingHours;
        //let hoursToSchedule = Math.min(totalRequiredHours, maxAllowedHours);
        let hoursToSchedule = totalRequiredHours;
        let currentDate = new Date(startDateStr);
        let currentHour = startHour;

        while (hoursToSchedule > 0) {
            const availableHoursToday = workingHours - currentHour;
            console.log("hoursToSchedule", hoursToSchedule);
            console.log("availableHoursToday", availableHoursToday);
            if (hoursToSchedule <= availableHoursToday) {
                currentHour += hoursToSchedule;
                hoursToSchedule = 0;
            } else {
                hoursToSchedule -= availableHoursToday;
                currentDate.setDate(currentDate.getDate() + 1);
                currentHour = 0;
            }
        }


        //console.log("startHour", startHour);
        // Make endHour 1 to lineWorkingHourCapacity
        if (currentHour === 0) currentHour = lineWorkingHourCapacity;

        return {
            endDate: currentDate.toISOString().split("T")[0],
            endHour: currentHour
        };
    }


    function updatedTak(taskId, fromDate, toDate) {

        console.log("tasks", tasks);
        console.log("ID", taskId);
        console.log("StartDate", fromDate);
        console.log("EndDate", toDate);
        const task = tasks.find(t => t.Id == taskId);
        if (!task) {
            console.warn("Task not found:", taskId);
            return;
        }

        task.FromDate = fromDate;
        task.ToDate = toDate;

        console.log("Updated Task:", task);
    }

})();

window.addEventListener("load", () => {
    document.querySelectorAll(".row").forEach(row => {
        const leftCol = row.querySelector(".line-name");
        if (!leftCol) return;

        const leftOffset = leftCol.getBoundingClientRect().width;
        const firstCell = row.querySelector(".cell");
        const dayWidth = firstCell.getBoundingClientRect().width;

        row.querySelectorAll(".task").forEach(task => {
            const startDay = parseInt(task.dataset.startDay || "0");
            const duration = parseInt(task.dataset.duration || "1");

            task.style.left = (startDay * dayWidth + leftOffset) + "px";
            task.style.width = (duration * dayWidth) + "px";
            task.style.top = "5px";
        });
    });

    const calendar = document.getElementById("calendar");
    const todayCell = document.querySelector(".cell.today");
    if (calendar && todayCell) {
        calendar.scrollLeft = todayCell.offsetLeft - (calendar.clientWidth / 2);

        const todayLine = document.createElement("div");
        todayLine.className = "today-line";
        todayLine.style.left = todayCell.offsetLeft + "px";
        calendar.appendChild(todayLine);
    }

    const button = document.querySelector('.task');

button.addEventListener('mousedown', () => {
  console.log('Mouse button pressed');
});
button.addEventListener('mouseup', () => {
  console.log('Mouse button released');
});
});
</script>
