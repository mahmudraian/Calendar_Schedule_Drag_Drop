@{
    var lines = ViewBag.Lines as List<WebApplication1.Models.SewingLineDto>;
    var tasks = ViewBag.Tasks as List<WebApplication1.Models.TaskIteMForDragAndDROP>;
    var tasksJson = Newtonsoft.Json.JsonConvert.SerializeObject(tasks);
    // Use dates from ViewBag (passed from controller)
    DateTime startDate = ViewBag.StartDate;
    DateTime endDate = ViewBag.EndDate;

    int workingHours = 10;

    // For navigation, previous and next month based on startDate
    DateTime currentMonth = new DateTime(startDate.Year, startDate.Month, 1);
    DateTime prevMonth = currentMonth.AddMonths(-12);
    DateTime nextMonth = currentMonth.AddMonths(11);
}

<style>
    /* --- Styles (same as before) --- */
    body {
        font-family: Arial;
    }

    .calendar {
        border: 1px solid #ccc;
        overflow-x: auto;
        overflow-y: auto;
        position: relative;
        background: #fff;
        width: 100%;
        white-space: nowrap;
        max-height: 700px;
    }

    .row {
        display: flex;
        position: relative;
        border-bottom: 1px solid #eee;
        height: 50px;
        flex-wrap: nowrap;
    }

    .line-name {
        width: 120px;
        background: #f3f3f3;
        border-right: 1px solid #ccc;
        font-weight: bold;
        flex: 0 0 120px;
        position: sticky;
        left: 0;
        z-index: 90;
    }

    .row:first-child .line-name {
        z-index: 110;
    }

    .cell {
        min-width: 40px;
        max-width: 40px;
        flex: 0 0 40px;
        border-right: 1px solid #F5E5E1;
        border-bottom: 1px solid #F5E5E1;
        text-align: center;
        font-size: 12px;
        box-sizing: border-box;
        position: relative;
    }

    .hour-row {
        display: flex;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
    }

    .hour-mini {
        flex: 1;
        border-left: 1px solid white;
        height: 100%;
    }

    /* .task {
            position: absolute;
            top: 5px;
            height: 40px;
            border-radius: 4px;
            color: #fff;
            font-size: 12px;
            padding: 5px;
            cursor: move;
            user-select: none;
            z-index: 50;
        }
    */


    .task {
        background-color: #F9DFDF;
        width: 40%;
        position: absolute;
        top: 50%;
        font-weight: 100;
        height: 45px;
        justify-content: center;
        border: 1px solid #333;
        /*    transform: translateY(-50%);*/
    }

    .today {
        background: #ffe082 !important;
        font-weight: bold;
    }

    .today-line {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 2px;
        background: red;
        z-index: 5;
        pointer-events: none;
    }

    .row:first-child {
        position: sticky;
        top: 0;
        z-index: 100;
        background: white;
    }

    .line-title {
        font-weight: 600;
        font-size: 14px;
    }

    .line-info {
        margin-top: 4px;
        font-size: 12px;
        color: #666;
        display: flex;
        gap: 10px;
    }

    /* .task.drag-preview {
            opacity: 0.7;
            outline: 2px dashed #333;
        }*/


</style>

<h3>Sewing Line Calendar</h3>

<!-- Date Selection Form -->
<div style="margin-bottom: 15px;">
    <form id="dateForm" method="get" action="@Url.Action("CalenderDrag")">
        <label>
            From:
            <input type="date" name="FromDate" value="@startDate.ToString("yyyy-MM-dd")" />
        </label>
        <label style="margin-left: 10px;">
            To:
            <input type="date" name="ToDate" value="@endDate.ToString("yyyy-MM-dd")" />
        </label>
        <button type="submit" style="margin-left: 10px;">Load Calendar</button>
        <button type="button" id="btn-tasks" style="margin-left: 10px;">Load Tasks</button>

    </form>
</div>


<div style="float:right;padding-bottom:10px">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#OrderModal">
        Orders
    </button>
</div>



<div class="modal fade" style="max-height:500px" id="OrderModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div id="model-order" class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Orders</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <p>Loading...</p>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>

        </div>
    </div>
</div>






<div class="calendar" id="calendar">

    <!-- Header Row -->
    <div class="row">
        <div class="line-name">Line</div>
        @for (var d = startDate; d <= endDate; d = d.AddDays(1))
        {
            var isToday = d.Date == DateTime.Today;
            <div class="cell @(isToday ? "today" : "")">@d.ToString("dd")</div>
        }
    </div>

    <!-- Lines & Tasks -->
    @foreach (var line in lines)
    {
        <div class="row" data-line="@line.LINE_ID" data-ManPower="@line.MAN_POWER" data-ManWorkLimite="@line.ManWorkLimite">
            <div class="line-name">

                <div class="line-title">@line.LINE_NAME</div>
                <div class="line-info">
                    <span>MP: @line.MAN_POWER</span>
                    <span>Limit/H: @line.ManWorkLimite</span>
                </div>

            </div>


            @for (var d = startDate; d <= endDate; d = d.AddDays(1))
            {
                var isToday = d.Date == DateTime.Today;
                <div class="cell @(isToday ? "today" : "")" data-date="@d.ToString("yyyy-MM-dd")">
                    <div class="hour-row">
                        @for (int h = 0; h < workingHours; h++)
                        {
                            <div class="hour-mini" data-hour="@h"></div>
                        }
                    </div>
                </div>
            }

            @{
                var lineTasks = tasks.Where(t => t.SewingLineId == line.LINE_ID).ToList();
            }




        </div>
    }
</div>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>


<!-- jQuery first -->
<!--<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>-->

 @*jQuery UI next*@ 
<link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

<!-- Bootstrap last (optional) -->
<!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>-->


<script>

     var tasks = @Html.Raw(tasksJson);

    $(document).ready(function () {
    const workingHours = @workingHours;
    let dragged = null;

        loadSwingLine();
        LoadOrders();

        function updateTaskPreview(taskEl, row, startDateStr, estimatedEndDate) {

           @*const calendarStart = new Date('@startDate.ToString("yyyy-MM-dd")T00:00:00');

            calendarStart.setHours(0, 0, 0, 0);
            console.log("calendarStart", calendarStart)

            const startDate = new Date(startDateStr);
            const endDate = new Date(estimatedEndDate);

            console.log("startDate update Task Preview", startDateStr)
            console.log("endDate update TaskPreview", estimatedEndDate)


            const startDay = dayDiff(calendarStart, startDate);
            const endDay = dayDiff(calendarStart, endDate) + 1;

            console.log("startDay", startDay)
            console.log("endDate", endDay)
            if (startDay < 0 || endDay <= 0) return;

            const dayWidth = row.querySelector(".cell")?.offsetWidth;
            if (!dayWidth || dayWidth === 0) return;

            const leftBase = row.querySelector(".line-name")?.offsetWidth || 0;


            //taskEl.style.position = "absolute";
            taskEl.style.left = `${leftBase + startDay * dayWidth}px`;
            taskEl.style.width = `${endDay * dayWidth}px`;
            taskEl.style.top = "6px";


            taskEl.style.transition = "width 0.08s linear";

            taskEl.classList.add("drag-preview");*@
        }



    document.addEventListener("dragstart", e => {
        //if (!e.target.classList.contains("task")) return;

        //draggedTask = e.target;

        //e.dataTransfer.setData("text/plain", "");
        if (e.target.classList.contains("task")) {
            draggedTask = e.target;
            e.dataTransfer.setData("text/plain", e.target.dataset.id);
            //e.dataTransfer.effectAllowed = "move";
        }

    });

    document.addEventListener("dragend", e => {
        if (!draggedTask) return;
        draggedTask = null;
    });

    document.addEventListener("dragover", e => {
        e.preventDefault();

        if (!draggedTask) return;

        const cell = e.target.closest(".cell");
        const hourMini = e.target.closest(".hour-mini");
        const row = e.target.closest(".row");

        if (!cell || !hourMini || !row) return;

        const lineId = row.dataset.line;
        const startDateStr = cell.dataset.date;      // yyyy-mm-dd
        const startHour = parseInt(hourMini.dataset.hour);
        const GivenDurationHours = 10;
        const TaskId = draggedTask.dataset.id;
        const TaskQuantity = draggedTask.dataset.quantity;
        const LineWorkingHourCapacity = row.dataset.manworklimite;
        const LineManPower = row.dataset.manpower;

        const estimated = calculateEstimatedEndDate(startDateStr, startHour, GivenDurationHours, LineWorkingHourCapacity, LineManPower, TaskQuantity)

       var taskDrag= updatedTak(TaskId, startDateStr, estimated.endDate,lineId)
        updateTaskPreview(draggedTask, row, startDateStr, estimated.endDate);
        const fromDate = $('input[name="FromDate"]').val();
        LoadTask(tasks, fromDate);
        console.log("taskDrag:", taskDrag);

        //console.log("Line ID:", lineId);
        console.log("Start:", startDateStr, startHour + ":00");
        console.log("Estimated END:", estimated.endDate, estimated.endHour + ":00");
        //console.log("Task Quantity:", TaskQuantity);
        //console.log("Working Hour Capacity:", LineWorkingHourCapacity);
        //console.log("Man Powerv:", LineManPower);
        console.log("estimated:", estimated);
    });


    document.addEventListener("drop", e => {
        e.preventDefault();
        if (!draggedTask) return;

        const hourMini = e.target.closest(".hour-mini");
        const cell = e.target.closest(".cell");
        const row = e.target.closest(".row");

        if (!hourMini || !cell || !row) {
            draggedTask = null;
            return;
        }

        console.log("draggedTask", draggedTask);
        row.appendChild(draggedTask);

        // Start hour & day index
        const startHour = parseInt(hourMini.dataset.hour, 10);
        const allCells = Array.from(row.querySelectorAll(".cell"));
        const dayIndex = allCells.indexOf(cell);

        // Position calculations
        const lineWidth = row.querySelector(".line-name").offsetWidth;
        const dayWidth = row.querySelector(".cell").offsetWidth;
        const hourWidth = dayWidth / workingHours;

        draggedTask.style.position = "absolute";
        draggedTask.style.left = (lineWidth + dayIndex * dayWidth + startHour * hourWidth) + "px";
        draggedTask.style.top = "5px";

        // Full task width based on duration
        const durationDays = parseInt(draggedTask.dataset.duration || "1", 10);
        draggedTask.style.width = (durationDays * dayWidth) + "px";

        // Log info
        console.log({
            taskId: draggedTask.dataset.id,
            lineId: row.dataset.line,
            startDate: cell.dataset.date,
            startHour,
            durationDays
        });

        draggedTask = null;
        const fromDate = $('input[name="FromDate"]').val();
        LoadTask(tasks, fromDate);
    });


    function calculateEstimatedEndDate(startDateStr, startHour, givenDurationDays, lineWorkingHourCapacity, lineManPower, taskQuantity) {
        const totalRequiredHours = Math.ceil(taskQuantity / lineWorkingHourCapacity);
        const maxAllowedHours = givenDurationDays * workingHours;
        //let hoursToSchedule = Math.min(totalRequiredHours, maxAllowedHours);
        let hoursToSchedule = totalRequiredHours;
        let currentDate = new Date(startDateStr);
        let currentHour = startHour;

        while (hoursToSchedule > 0) {
            const availableHoursToday = workingHours - currentHour;
            console.log("hoursToSchedule", hoursToSchedule);
            console.log("availableHoursToday", availableHoursToday);
            if (hoursToSchedule <= availableHoursToday) {
                currentHour += hoursToSchedule;
                hoursToSchedule = 0;
            } else {
                hoursToSchedule -= availableHoursToday;
                currentDate.setDate(currentDate.getDate() + 1);
                currentHour = 0;
            }
        }


        //console.log("startHour", startHour);
        // Make endHour 1 to lineWorkingHourCapacity
        if (currentHour === 0) currentHour = lineWorkingHourCapacity;

        return {
            endDate: currentDate.toISOString().split("T")[0],
            endHour: currentHour
        };
    }

    function updatedTak(taskId, fromDate, toDate,lineID) {

        console.log("tasks", tasks);
        console.log("ID", taskId);
        console.log("StartDate", fromDate);
        console.log("EndDate", toDate);
        console.log("lineID", lineID);
        const task = tasks.find(t => t.Id == taskId);
        if (!task) {
            console.warn("Task not found:", taskId);
            return;
        }

        task.FromDate = fromDate;
        task.ToDate = toDate;
        task.SewingLineId = lineID;

        return task;
        }



    });


    function dayDiff(date1, date2) {
        const d1 = new Date(date1);
        const d2 = new Date(date2);

        if (isNaN(d1) || isNaN(d2)) {
            console.error("Invalid dates in dayDiff", date1,'~~~~~~~~~', date2);
            return NaN;
        }

        d1.setHours(0, 0, 0, 0);
        d2.setHours(0, 0, 0, 0);

        return Math.round((d2 - d1) / (1000 * 60 * 60 * 24));
    }

    const OrderModal = document.getElementById('OrderModal');
    OrderModal.addEventListener('show.bs.modal', function (event) {
        LoadOrders();
    });

    //$(function () {
    //    // Make the modal draggable by its header
    //    $("#OrderModal .modal-dialog").draggable({
    //        handle: ".modal-header",
    //        containment: "window"
    //    });
    //});



    function LoadOrders() {
        $.ajax({
            url: '/Home/Orders',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                let modalBody = $('#OrderModal .modal-body');
                modalBody.empty(); // Clear previous content

                if (data.length === 0) {
                    modalBody.append('<p>No orders found.</p>');
                    return;
                }

                // Create table
                let table = $('<table class="table table-bordered table-striped"></table>');
                let thead = `
                <thead style="position: sticky; top: 0; background-color: #fff; z-index: 10;">
                    <tr>
                        <th>Order ID</th>
                        <th>Company</th>
                        <th>Quantity</th>
                        <th>Maximum Days</th>
                    </tr>
                </thead>`;
                table.append(thead);

                let tbody = $('<tbody></tbody>');
                data.forEach(order => {
                    let row = $(`
                    <tr class="draggable-row">
                        <td>${order.OrderId}</td>
                        <td>${order.OrderCompany || ''}</td>
                        <td>${order.Quantity}</td>
                        <td>${order.MaximumDays}</td>
                    </tr>
                `);
                    tbody.append(row);
                });

                table.append(tbody);
                modalBody.append(table);

                // Make rows draggable using jQuery UI
                //$('.draggable-row').draggable({
                //    helper: 'clone', // So the original row stays in place
                //    cursor: 'move',
                //    zIndex: 100,
                //    revert: 'invalid' // Snap back if not dropped
                //});

                // Optional: Make a drop target (if needed)
                // $('#DropTarget').droppable({
                //     accept: '.draggable-row',
                //     drop: function(event, ui) {
                //         $(this).append(ui.draggable.clone());
                //     }
                // });
            },
            error: function (err) {
                console.error("Error loading orders:", err);
                $('#OrderModal .modal-body').html('<p>Error loading orders.</p>');
            }
        });
    }


    function LoadTask(tasks, calendarStartDate) {

        $('.task').remove();

        const calendarStart = new Date(calendarStartDate);
        calendarStart.setHours(0, 0, 0, 0);

        tasks.forEach(task => {

            const $row = $('.row[data-line="' + task.SewingLineId + '"]');
            if (!$row.length) return;

            const $firstCell = $row.find('.cell').first();
            if (!$firstCell.length) return;

            const taskStart = new Date(task.FromDate.split('T')[0]);
            const taskEnd = new Date(task.ToDate.split('T')[0]);

            const startDay = dayDiff(calendarStart, taskStart);
            const duration = dayDiff(taskStart, taskEnd) + 1;

            if (startDay < 0 || duration <= 0) return;

            const dayWidth = $firstCell.outerWidth();
            const leftBase = $row.find('.line-name').outerWidth();

            const $task = $('<div>', {
                class: 'task',
                text: task.TaskName,
                draggable: true,
                css: {
                    left: leftBase + startDay * dayWidth + 'px',
                    top: '6px',
                    width: duration * dayWidth + 'px',
                    position: 'absolute',
                    //background: task.ColorCode || '#87cefa',
                    border: '1px solid #333',
                    //height: '22px',
                    lineHeight: '22px',
                    overflow: 'hidden',
                    whiteSpace: 'nowrap'
                }
            })
                .attr('data-id', task.Id)
                .attr('data-duration', duration)
                .attr('data-quantity', task.Quantity);

            $row.append($task);
        });



    }



 $('#btn-tasks').on('click', function (event) {
     event.preventDefault();

     const fromDate = $('input[name="FromDate"]').val();
     const toDate = $('input[name="ToDate"]').val();

     console.log("Load tasks for:", fromDate, "to", toDate);

     LoadTask(tasks, fromDate);
 });


    function loadSwingLine() {
        $.ajax({
            url: '/Home/SwingLineForPlan',
            type: 'GET',
            dataType: 'json',
            success: function (response) {
                console.log('Swing Line Data:', response);
                response.forEach(function (line) {
                   
                });
            },
            error: function (err) {
                console.error('Error loading swing line', err);
            }
        });
    }


window.addEventListener("load", () => {
    document.querySelectorAll(".row").forEach(row => {
        const leftCol = row.querySelector(".line-name");
        if (!leftCol) return;

        const leftOffset = leftCol.getBoundingClientRect().width;
        const firstCell = row.querySelector(".cell");
        const dayWidth = firstCell.getBoundingClientRect().width;

        row.querySelectorAll(".task").forEach(task => {
            const startDay = parseInt(task.dataset.startDay || "0");
            const duration = parseInt(task.dataset.duration || "1");

            task.style.left = (startDay * dayWidth + leftOffset) + "px";
            task.style.width = (duration * dayWidth) + "px";
            task.style.top = "5px";
        });
    });

    const calendar = document.getElementById("calendar");
    const todayCell = document.querySelector(".cell.today");
    if (calendar && todayCell) {
        calendar.scrollLeft = todayCell.offsetLeft - (calendar.clientWidth / 2);

        const todayLine = document.createElement("div");
        todayLine.className = "today-line";
        todayLine.style.left = todayCell.offsetLeft + "px";
        calendar.appendChild(todayLine);
    }




});
</script>

