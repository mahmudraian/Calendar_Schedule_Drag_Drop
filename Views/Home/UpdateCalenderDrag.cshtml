@{
    var lines = ViewBag.Lines as List<WebApplication1.Models.SewingLineDto>;
    var linesJson = Newtonsoft.Json.JsonConvert.SerializeObject(lines);
    var tasks = ViewBag.Tasks as List<WebApplication1.Models.PlanProductionModel>;
    var tasksJson = Newtonsoft.Json.JsonConvert.SerializeObject(tasks);
    DateTime startDate = ViewBag.StartDate;
    DateTime endDate = ViewBag.EndDate;
    int workingHours = 10; // daily working hours
}
<style>
    :root {
        --line-width: 180px;
        --cell-width: 120px;
/*        --row-height: 55px;*/
    }

    /* Wrapper */
    .calendar-wrapper {
        overflow-x: auto;
        border: 1px solid #ccc;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
        max-height: 550px;
    }


    /* Header */
    .calendar-header {
        position: sticky;
        top: 0;
        z-index: 1000; /* higher than tasks */
        background-color: #f8f9fa;
        display: flex;
        border-bottom: 2px solid #ddd;
        /* IMPORTANT */
        background-clip: padding-box;
    }



    /* Body */
    .calendar-body {
        display: flex;
        flex-direction: column;
    }

    .calendar-row {
        display: inline-flex;
        flex-wrap: nowrap;
        height: var(--row-height); /* 🔑 source of height */
        position: relative;
        width: max-content;
        height: 55px;
    }


    .calendar-header .cell::after {
        background: #ddd;
    }

    .calendar-header .cell {
        display: flex;
        flex-direction: column;
        justify-content: center;
        font-weight: 600;
    }

    .row {
        display: flex;
        flex-wrap: nowrap;
        height: var(--row-height);
        position: relative;
    }

        /* solid row border */
        .row::after {
            content: "";
            position: absolute;
            left: 0;
            right: 0;
            bottom: 0;
            height: 1px;
            background: #dcdcdc;
        }

   


    /* line column */
    .line-name {
        width: var(--line-width);
        min-width: var(--line-width);
        flex-shrink: 0;
        padding: 10px;
        background: #fafafa;
        border-right: 1px solid #ddd;
        font-weight: 600;
        border-bottom: 1px solid #e9d7d7;
        position: sticky;
    }

    /* calendar cell */
    .cell {
        width: var(--cell-width);
        min-width: var(--cell-width);
        flex-shrink: 0;
        position: relative;
        border-bottom: 1px solid #e9d7d7;
    }

        /* vertical grid lines */
        .cell::after {
            content: "";
            position: absolute;
            top: 0;
            bottom: 0;
            right: 0;
            width: 1px;
            background-color: #e0e0e0; /* slightly darker */
            pointer-events: none;
        }



    /* Sunday */
    .disabled-day {
        background: #f3f3f3;
    }

/*    .task {
        position: absolute;
        top: 5px;
        height: calc(var(--row-height));
        line-height: calc(var(--row-height) - 10px);
        background-color: #F5AFAF;
        z-index: 5;
        border:1px solid;
        padding:1px;
    }*/

    .task {
        height: 30px;
        background: #ff6600;
        color: #fff;
        font-size: 12px;
        z-index: 10;
        border-radius: 4px;
        cursor: pointer;
    }


</style>
<div style="margin-bottom:15px;">

    <h3>Sewing Line Calendar</h3>

    <div style="margin-bottom:15px;">
        <form id="dateForm" method="get" action="@Url.Action("UpdateCalenderDrag")">
            From: <input type="date" name="FromDate" value="@(startDate.ToString("yyyy-MM-dd"))" />
            To: <input type="date" name="ToDate" value="@(endDate.ToString("yyyy-MM-dd"))" />
            <button type="submit">Load Calendar</button>
            <button type="button" id="btn-tasks">Load Tasks</button>
        </form>

    </div>

    <div class="container-fluid">
        <div class="row">
            @*<div class="col-3 bg-dark text-white p-3" style="height:100vh;overflow-y:auto;">
                    <h4>Order List</h4>
                    <ul id="sidebar-orders"><li>Loading...</li></ul>
                </div>*@

            <div class="col-12">
                <div class="calendar-wrapper">
                    <div id="calendar-header" class="calendar-header"></div>
                    <div id="calendar-body" class="calendar-body"></div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <script>
const WORKING_HOURS = @workingHours;
let tasks = @Html.Raw(tasksJson);
let lines = @Html.Raw(linesJson);
    const TOTAL_DAYS = 365 * 2; // 2 years
    const TOTAL_WEEKS = 104; // 2 years
let draggedTask = null;
let lastHover = null;

// --- Date Helpers ---
function parseDateSafe(str){
    if(!str) return null;
    if(str instanceof Date) return str;
    const d = new Date(str);
    return isNaN(d.getTime()) ? null : d;
}

function formatYMD(d){
    const date = parseDateSafe(d);
    if(!date) return "";
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

function addDays(date,days){
    const d=new Date(date);
    d.setDate(d.getDate()+days);
    return d;
}

function dayDiff(a,b){
    return Math.floor((b - a)/(1000*60*60*24));
}

// --- Calendar Render ---
    function renderCalendar() {
        const fromDate = parseDateSafe($('input[name="FromDate"]').val());
        const toDate = parseDateSafe($('input[name="ToDate"]').val());
        if (!fromDate || !toDate) return;

        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const totalDays = dayDiff(fromDate, toDate);

        /* ================= HEADER ================= */
        const header = document.getElementById('calendar-header');
        header.innerHTML = '';

        const headerLine = document.createElement('div');
        headerLine.className = 'line-name';
        headerLine.textContent = 'Line';
        header.appendChild(headerLine);

        for (let i = 0; i <= totalDays; i++) {
            const currentDate = addDays(fromDate, i);

            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.dataset.date = formatYMD(currentDate);
            cell.innerHTML = `
            <div>${dayNames[currentDate.getDay()]}</div>
            <div>
            ${currentDate.getDate()}/
            ${currentDate.getMonth() + 1}/
            ${currentDate.getFullYear()}
            </div>

        `;

            header.appendChild(cell);
        }

        /* ================= BODY ================= */
        const body = document.getElementById('calendar-body');
        body.innerHTML = '';

        lines.forEach(line => {
            const row = document.createElement('div');
            row.className = 'calendar-row';
            row.dataset.line = line.LINE_ID;

            const lineDiv = document.createElement('div');
            lineDiv.className = 'line-name';
            lineDiv.textContent = line.LINE_NAME;
            row.appendChild(lineDiv);

            for (let i = 0; i <= totalDays; i++) {
                const currentDate = addDays(fromDate, i);
                const isSunday = currentDate.getDay() === 0;

                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.date = formatYMD(currentDate);

                if (isSunday) {
                    cell.classList.add('disabled-day');
                }

                row.appendChild(cell);
            }

            body.appendChild(row);
        });
        renderTasks(fromDate,toDate) 
    }

        function parseDMY(dateStr) {
            if (!dateStr) return null;

            // supports: "03-01-2026" OR "03 - 01 - 2026"
            const parts = dateStr.includes('-')
                ? dateStr.split('-')
                : dateStr.split(' - ');

            if (parts.length !== 3) return null;

            const day = Number(parts[0]);
            const month = Number(parts[1]);
            const year = Number(parts[2]);

            return new Date(year, month - 1, day);
        }


        // Helper to get days difference (calendar days, not hours)
        function dayDiff(start, end) {
            const msPerDay = 24 * 60 * 60 * 1000;
            return Math.round((end - start) / msPerDay);
        }


        function durationToHours(duration) {
            const days = Math.floor(duration);
            const fraction = duration - days;
            return (days * WORKING_HOURS) + Math.round(fraction * WORKING_HOURS);
        }

        const TASK_COLORS = [
            "#FF5733",
            "#33B5E5",
            "#9C27B0",
            "#4CAF50",
            "#FFC107",
            "#E91E63",
            "#009688",
            "#3F51B5",
            "#FF9800",
            "#795548"
        ];

        function getRandomTaskColor() {
            return TASK_COLORS[Math.floor(Math.random() * TASK_COLORS.length)];
        }

        function renderTasks(calendarStart, calendarEnd) {
            document.querySelectorAll('.task').forEach(t => t.remove());

            tasks.forEach(task => {
                const row = document.querySelector(
                    `.calendar-row[data-line="${task.line_id}"]`
                );
                if (!row) return;

                let start = parseDMY(task.start_date);
                if (!start) return;

                // ✅ STRICT FILTER — do NOT clamp
                if (start < calendarStart || start > calendarEnd) return;

                const startDayIndex = dayDiff(calendarStart, start);

                const firstCell = row.querySelector('.cell');
                if (!firstCell) return;

                const dayWidth = firstCell.offsetWidth;
                const hourWidth = dayWidth / WORKING_HOURS;
                const lineWidth = row.querySelector('.line-name')?.offsetWidth || 180;

                const left =
                    lineWidth +
                    (startDayIndex * dayWidth) +
                    (task.start_hour * hourWidth);

                const width = hourWidth * durationToHours(task.duration);

                const taskDiv = document.createElement('div');
                taskDiv.className = 'task';
                taskDiv.textContent = task.JOB_NO;

                taskDiv.style.position = 'absolute';
                taskDiv.style.left = `${left}px`;
                taskDiv.style.width = `${Math.max(width, 4)}px`;
                taskDiv.style.top = '0px';
                taskDiv.style.background = getRandomTaskColor();

                taskDiv.dataset.id = task.plan_id;
                taskDiv.dataset.startDate = task.start_date;
                taskDiv.dataset.end_date = task.end_date;
                taskDiv.dataset.startHour = task.start_hour;
                taskDiv.dataset.end_hour = task.end_hour;
                taskDiv.dataset.duration = task.duration;
                taskDiv.dataset.name = task.plan_id;
                taskDiv.dataset.quantity = task.plan_qnty;
                row.appendChild(taskDiv);
            });
        }



// --- Hover / Drag ---
function getHoverInfo(e,row){
    const rowRect=row.getBoundingClientRect();
    const lineWidth=row.querySelector(".line-name").offsetWidth;
    const x=e.clientX - rowRect.left - lineWidth;
    if(x<0) return null;

    const cells=row.querySelectorAll(".cell");
    const dayWidth=cells[0].offsetWidth;
    const hourWidth=dayWidth/WORKING_HOURS;
    const dayIndex=Math.floor(x/dayWidth);
    const hour=Math.floor((x%dayWidth)/hourWidth);
    if(!cells[dayIndex]) return null;

    return {row, cell: cells[dayIndex], dayIndex, hour};
}

document.addEventListener("dragstart",e=>{
    if(e.target.classList.contains("task")) draggedTask=e.target;
});

document.addEventListener("dragend",()=>{
    draggedTask=null;
    lastHover=null;
});

document.addEventListener("dragover",e=>{
    e.preventDefault();
    if(!draggedTask) return;
    lastHover=getHoverInfo(e,e.target.closest(".row"));
});

document.addEventListener("drop",e=>{
    e.preventDefault();
    if(!draggedTask || !lastHover) return;

    const {row, cell, hour} = lastHover;
    const taskId = draggedTask.dataset.id;
    const task = tasks.find(t => t.plan_id == taskId);
    if(!task) return;

    // Preserve duration
    const durationHours = task.end_hour + dayDiff(parseDateSafe(task.start_date), parseDateSafe(task.end_date))*WORKING_HOURS - task.start_hour;
    task.start_date = cell.dataset.date;
    task.start_hour = hour;
    const endDateObj = addDays(parseDateSafe(cell.dataset.date), Math.floor((hour + durationHours)/WORKING_HOURS));
    const endHour = (hour + durationHours) % WORKING_HOURS;
    task.end_date = formatYMD(endDateObj);
    task.end_hour = endHour;
    task.line_id = parseInt(row.dataset.line);

    draggedTask = null;
    lastHover = null;

    renderCalendar();
});

// --- Init ---
$(document).ready(()=>{
    renderCalendar();
    $('#btn-tasks').click(()=>renderCalendar());
});
    </script>
