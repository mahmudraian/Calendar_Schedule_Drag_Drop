@{
    var lines = ViewBag.Lines as List<WebApplication1.Models.SewingLineDto>;
    var linesJson = Newtonsoft.Json.JsonConvert.SerializeObject(lines);
    var tasks = ViewBag.Tasks as List<WebApplication1.Models.PlanProductionModel>;
    var tasksJson = Newtonsoft.Json.JsonConvert.SerializeObject(tasks);
    DateTime startDate = ViewBag.StartDate;
    DateTime endDate = ViewBag.EndDate;
    int workingHours = 10; // daily working hours
}
<style>
    #calendar .row {
        display: flex;
        height: 70px; /* increased row height */
        border-bottom: 1px solid #ddd;
        position: relative;
    }

    .calendar-wrapper {
        overflow-x: auto;
        border: 1px solid #ccc;
        max-height: 700px;
    }

    .calendar-header, .row {
        display: flex;
    }

    .line-name {
        width: 200px; /* slightly wider for readability */
        flex-shrink: 0;
        background: #f2f2f2;
        padding: 8px;
        box-sizing: border-box;
        position: sticky;
        left: 0;
        z-index: 5;
        font-weight: bold;
    }

    .cell {
        flex: 1;
        border-left: 1px solid #eee;
        position: relative;
        min-width: 80px; /* increase cell width */
    }

    .task {
        position: absolute;
        height: 60px; /* taller task */
        background: #4caf50;
        color: white;
        text-align: center;
        line-height: 60px; /* match row height */
        border-radius: 4px;
        cursor: grab;
        overflow: hidden;
        font-size: 14px;
    }

    .cell-hover {
        background: rgba(0,123,255,0.2);
    }

</style>

<h3>Sewing Line Calendar</h3>

<div style="margin-bottom:15px;">
    <form id="dateForm" method="get" action="@Url.Action("UpdateCalenderDrag")">
        From: <input type="date" name="FromDate" value="@(startDate.ToString("yyyy-MM-dd"))" />
        To: <input type="date" name="ToDate" value="@(endDate.ToString("yyyy-MM-dd"))" />
        <button type="submit">Load Calendar</button>
        <button type="button" id="btn-tasks">Load Tasks</button>
    </form>

</div>

<div class="container-fluid">
    <div class="row">
        @*<div class="col-3 bg-dark text-white p-3" style="height:100vh;overflow-y:auto;">
            <h4>Order List</h4>
            <ul id="sidebar-orders"><li>Loading...</li></ul>
        </div>*@

        <div class="col-12">
            <div id="calendar-wrapper" style="overflow-x: auto; border: 1px solid #ccc; white-space: nowrap; max-height: 500px;">
                <div id="calendar-header" style="display:flex; position:sticky; top:0; background:#fff; z-index:10;"></div>
                <div id="calendar-body"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

<script>
const WORKING_HOURS = @workingHours;
let tasks = @Html.Raw(tasksJson);
let lines = @Html.Raw(linesJson);
    const TOTAL_DAYS = 365 * 2; // 2 years
    const TOTAL_WEEKS = 104; // 2 years
let draggedTask = null;
let lastHover = null;

// --- Date Helpers ---
function parseDateSafe(str){
    if(!str) return null;
    if(str instanceof Date) return str;
    const d = new Date(str);
    return isNaN(d.getTime()) ? null : d;
}

function formatYMD(d){
    const date = parseDateSafe(d);
    if(!date) return "";
    return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')}`;
}

function addDays(date,days){
    const d=new Date(date);
    d.setDate(d.getDate()+days);
    return d;
}

function dayDiff(a,b){
    return Math.floor((b - a)/(1000*60*60*24));
}

// --- Calendar Render ---
    // --- Calendar Render ---
    function renderCalendar() {
        const fromDate = parseDateSafe($('input[name="FromDate"]').val());
        const toDate = parseDateSafe($('input[name="ToDate"]').val());
        if (!fromDate || !toDate) return;

        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

        // --- Header ---
        const header = document.getElementById('calendar-header');
        header.innerHTML = '<div class="line-name">Line</div>';

        // Calculate number of days dynamically
        const totalDays = dayDiff(fromDate, toDate);

        for (let i = 0; i <= totalDays; i++) {
            const currentDate = addDays(fromDate, i);
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.style.width = '60px';
            cell.style.borderLeft = '1px solid #eee';
            cell.textContent = `${dayNames[currentDate.getDay()]} ${currentDate.getDate()}/${currentDate.getMonth() + 1}`;
            cell.dataset.date = formatYMD(currentDate);
            header.appendChild(cell);
        }

        // --- Body ---
        const body = document.getElementById('calendar-body');
        body.innerHTML = '';
        lines.forEach(line => {
            const row = document.createElement('div');
            row.className = 'row';
            row.dataset.line = line.LINE_ID;

            const lineDiv = document.createElement('div');
            lineDiv.className = 'line-name';
            lineDiv.textContent = line.LINE_NAME;
            row.appendChild(lineDiv);

            for (let i = 0; i <= totalDays; i++) {
                const currentDate = addDays(fromDate, i);

                // Header cell
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.style.width = '80px'; // match CSS
                cell.style.borderLeft = '1px solid #eee';
                cell.textContent = `${dayNames[currentDate.getDay()]} ${currentDate.getDate()}/${currentDate.getMonth() + 1}`;
                cell.dataset.date = formatYMD(currentDate);
                header.appendChild(cell);
            }

            // Body cells
            lines.forEach(line => {
                const row = document.createElement('div');
                row.className = 'row';
                row.dataset.line = line.LINE_ID;

                const lineDiv = document.createElement('div');
                lineDiv.className = 'line-name';
                lineDiv.textContent = line.LINE_NAME;
                row.appendChild(lineDiv);

                for (let i = 0; i <= totalDays; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.style.width = '80px'; // match header width
                    row.appendChild(cell);
                }

                body.appendChild(row);
            });


            body.appendChild(row);
        });

        renderTasks(fromDate); // render tasks in days scale
    }


    // --- Render tasks scaled by weeks ---
    function renderTasksWeek(calendarStart) {
        tasks.forEach(task => {
            const row = document.querySelector(`.row[data-line="${task.line_id}"]`);
            if (!row) return;

            const start = parseDateSafe(task.start_date);
            const end = parseDateSafe(task.end_date);
            if (!start || !end) return;

            // Task start and duration in weeks
            const startWeekIndex = Math.floor(dayDiff(calendarStart, start) / 7);
            const durationWeeks = Math.ceil((dayDiff(start, end) + 1) / 7);

            const $row = $(row);
            const weekWidth = $row.find('.cell').first().outerWidth();
            const leftBase = $row.find('.line-name').outerWidth();
            const leftOffset = leftBase + startWeekIndex * weekWidth;
            const totalWidth = durationWeeks * weekWidth;

            const $task = $('<div>', {
                class: 'task',
                text: task.JOB_NO,
                title: `${task.JOB_NO}\n${task.start_date} → ${task.end_date}`,
                draggable: true,
                css: {
                    position: 'absolute',
                    left: leftOffset + 'px',
                    top: '4px',
                    width: totalWidth + 'px',
                    height: '45px',
                    lineHeight: '45px',
                    whiteSpace: 'nowrap',
                    overflow: 'hidden',
                    background: '#4CAF50',
                    color: '#fff',
                    borderRadius: '4px',
                    cursor: 'grab'
                }
            }).attr({
                'data-id': task.plan_id,
                'data-start-date': task.start_date,
                'data-end-date': task.end_date,
            });

            $row.append($task);
        });
    }

// --- Render Tasks ---
function renderTasks(calendarStart){
    tasks.forEach(task=>{
        const row=document.querySelector(`.row[data-line="${task.line_id}"]`);
        if(!row) return;

        const start=parseDateSafe(task.start_date);
        const end=parseDateSafe(task.end_date);
        if(!start||!end) return;

        let startDayIndex = dayDiff(calendarStart,start);
        if(startDayIndex<0) startDayIndex=0;

        let totalHours;
        if(start.toDateString() === end.toDateString()){
            totalHours = task.end_hour - task.start_hour;
        } else {
            const daysBetween = dayDiff(start,end)-1;
            totalHours = (WORKING_HOURS - task.start_hour) + daysBetween*WORKING_HOURS + task.end_hour;
        }

        const $row = $(row);
        const dayWidth = $row.find('.cell').first().outerWidth();
        const hourWidth = dayWidth / WORKING_HOURS;
        const leftBase = $row.find('.line-name').outerWidth();
        const leftOffset = leftBase + startDayIndex*dayWidth + task.start_hour*hourWidth;
        const totalWidth = totalHours*hourWidth;

        const $task = $('<div>',{
            class:'task',
            text:task.JOB_NO,
            draggable:true,
            css:{
                position:'absolute',
                left:leftOffset+'px',
                top:'4px',
                width:totalWidth+'px',
                height:'45px',
                lineHeight:'45px',
                whiteSpace:'nowrap',
                overflow:'hidden',
                background:'#4CAF50',
                color:'#fff',
                borderRadius:'4px',
                cursor:'grab'
            }
        }).attr({
            'data-id':task.plan_id,
            'data-start-date':formatYMD(start),
            'data-start-hour':task.start_hour,
            'data-end-date':formatYMD(end),
            'data-end-hour':task.end_hour,
            'data-name':task.JOB_NO,
            'data-quantity':task.plan_qnty
        });

        $row.append($task);
    });
}

// --- Hover / Drag ---
function getHoverInfo(e,row){
    const rowRect=row.getBoundingClientRect();
    const lineWidth=row.querySelector(".line-name").offsetWidth;
    const x=e.clientX - rowRect.left - lineWidth;
    if(x<0) return null;

    const cells=row.querySelectorAll(".cell");
    const dayWidth=cells[0].offsetWidth;
    const hourWidth=dayWidth/WORKING_HOURS;
    const dayIndex=Math.floor(x/dayWidth);
    const hour=Math.floor((x%dayWidth)/hourWidth);
    if(!cells[dayIndex]) return null;

    return {row, cell: cells[dayIndex], dayIndex, hour};
}

document.addEventListener("dragstart",e=>{
    if(e.target.classList.contains("task")) draggedTask=e.target;
});

document.addEventListener("dragend",()=>{
    draggedTask=null;
    lastHover=null;
});

document.addEventListener("dragover",e=>{
    e.preventDefault();
    if(!draggedTask) return;
    lastHover=getHoverInfo(e,e.target.closest(".row"));
});

document.addEventListener("drop",e=>{
    e.preventDefault();
    if(!draggedTask || !lastHover) return;

    const {row, cell, hour} = lastHover;
    const taskId = draggedTask.dataset.id;
    const task = tasks.find(t => t.plan_id == taskId);
    if(!task) return;

    // Preserve duration
    const durationHours = task.end_hour + dayDiff(parseDateSafe(task.start_date), parseDateSafe(task.end_date))*WORKING_HOURS - task.start_hour;
    task.start_date = cell.dataset.date;
    task.start_hour = hour;
    const endDateObj = addDays(parseDateSafe(cell.dataset.date), Math.floor((hour + durationHours)/WORKING_HOURS));
    const endHour = (hour + durationHours) % WORKING_HOURS;
    task.end_date = formatYMD(endDateObj);
    task.end_hour = endHour;
    task.line_id = parseInt(row.dataset.line);

    draggedTask = null;
    lastHover = null;

    renderCalendar();
});

// --- Init ---
$(document).ready(()=>{
    renderCalendar();
    $('#btn-tasks').click(()=>renderCalendar());
});
</script>
